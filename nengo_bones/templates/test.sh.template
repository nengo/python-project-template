{% extends "base_script.sh.template" %}

{% block install %}
{{ super() }}
    {# TODO: switch to templating requirements in setup.py, then remove these #}
    exe pip install "pytest>=3.6.0"
    exe pip install "pytest-xdist>=1.16.0"
    {% if coverage %}
    exe pip install "pytest-cov>=2.6.0"
    {% endif %}
    exe pip install -e ".[tests]"
{% endblock %}

{% block script %}
    # shellcheck disable=SC2086
    exe pytest {{ pkg_name }} -v -n 2 --color=yes --durations 20 {%- if coverage %} --cov={{ pkg_name }} --cov-report=term-missing {%- endif %} $TEST_ARGS

    {% if nengo_tests %}
    # shellcheck disable=SC2086
    exe pytest --pyargs nengo -v -n 2 --color=yes --durations 20 {%- if coverage %} --cov={{ pkg_name }} --cov-append --cov-report=term-missing {%- endif %} $TEST_ARGS
    {% endif %}
{% endblock %}

{% block after_script %}
    {% if coverage %}
    curl -s https://codecov.io/bash > codecov
    CODECOV_VERSION="$(grep 'VERSION=\".*\"' codecov | cut -d'"' -f2)"
    VALIDATION_FAILURE=0
    for i in 1 256 512
    do
      IS_DIFF="$(diff <(shasum -a $i codecov) <(curl -s https://raw.githubusercontent.com/codecov/codecov-bash/"$CODECOV_VERSION"/SHA${i}SUM))"
      if [ -z "${IS_DIFF}" ]; then
        echo "Sha:" $i "passes validation"
      else
        echo "Sha:" $i "fails validation"
        VALIDATION_FAILURE=1
      fi
    done
    if [ "${VALIDATION_FAILURE}" == 1 ]; then
      echo "Invalid Checksum Detected From Codecov. Skipping upload."
      STATUS=1
    else
      echo "Starting Codecov"
      exe chmod +x codecov
      exe ./codecov
    fi
    {% else %}
    :
    {% endif %}
{% endblock %}
